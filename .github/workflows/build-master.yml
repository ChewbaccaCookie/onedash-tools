name: Build Master

on:
    push:
        branches: [master]

jobs:
    build-tools:
        name: "Build and Publish"
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  persist-credentials: false
            - uses: actions/setup-node@v1
              with:
                  node-version: 13
                  registry-url: https://npm.onedash.dev/
            - uses: actions/cache@v1
              name: "Cache .npm"
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: "Install Dependencies"
              run: npm i
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: "üö¶ Run Linter"
              run: npm run lint

            - name: "üèó Build tools"
              run: npm run build

            - name: "üîù Automated Version Bump"
              uses: "phips28/gh-action-bump-version@master"
              with:
                  tag-prefix: ""
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: "üöÄ Publish to Registry"
              run: npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    build-storybook:
        name: "Build Storybook"
        runs-on: ubuntu-latest
        needs: [build-tools]
        steps:
            - uses: actions/checkout@v2
              with:
                  persist-credentials: false
            - uses: actions/setup-node@v1
              with:
                  node-version: 13
                  registry-url: https://npm.onedash.dev/
            - uses: actions/cache@v1
              name: "Cache .npm"
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-

            - name: "Install Dependencies"
              run: npm i
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: "üõ† Build Storybook"
              run: npm run build-storybook

            - name: "üì∞ Publish Storybook"
              uses: JamesIves/github-pages-deploy-action@releases/v3
              with:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  BRANCH: gh-pages # The branch the action should deploy to.
                  FOLDER: public # The folder the action should deploy.
                  DEBUG: true
